https://github.com/user-attachments/assets/a1e2b5e0-675c-4bcf-8ad0-2099b53011ab

tarBSD is a minimal (well, depends on chosen features and packages) FreeBSD image that boots to memory. Most of it is stored in a tar archive mounted at /usr. tarBSD is not a distubution upon iself. Instead, this repository gives you a tool to build a your own version of it.

Because most of tarBSD is in a tightly compressed ([zstd-19](https://github.com/facebook/zstd)) tar archive that is mounted rather than extracted at boot, it doesn't need nearly as much ram as traditional mfs images.

Please note that this is an early version and things might change. Don't expect two images generated by two diffferent builder versions to contain exactly the same stuff.

## Possible use cases for tarBSD ##
* router
* NAS
* virtualization host
* all the above in a one box
* a remote FreeBSD installer with SSH

## Installing the builder tool ##

Download it from the [releases](/releases) page. In order to run it, you'll need PHP >= 8.2 with phar, zlib, pcntl and either mbstring or iconv extensions. Zopfli enables slightly better kernel compression, but it is optional.

```
pkg install php84 php84-phar php84-zlib php84-pcntl php84-mbstring zopfli

# make tarbsd builder executable
chmod +x tarbsd

# move it to /usr/local/sbin
mv tarbsd /usr/local/sbin/tarbsd
```

## Usage ##
Start by creating a project directory and issuing tarbsd bootstrap command there.

```
mkdir myproject
cd myproject
tarbsd bootstrap
```
It'll ask few questions, create a configuration file as well as tarbsd overlay directory, which contents will be recursively copied to the image. You'll likely want to edit tarbsd.yml and tarbsd/etc/rc.conf at least.

Now you can build the image. If you have a FreeBSD installation medium mounted at /mnt, /media or /cdrom, distribution tarballs (base.txz and kernel.txz) are automatically used from there unless otherwise specified with --distfiles option. You can also download them from [here](https://download.freebsd.org/ftp/releases/amd64/).
```
tarbsd build --distfiles /path/to/dist/files
```

It extracts base.txz and kernel txz on the first run, so it might take a while. Subsequent builds however, are quicker. It uses in-memory zfs pool for building, so everyting is snappy and there's no unnecesary writes to your storage medium. ZFS also allows builder to use snapshots to restore the image to a an earlier state before each build. The pool is 2 gigs and there's no way to configure this at the moment.

When in hurry, pass --quick option to the builder. You'll get the image quicker, but it will be bigger and require more memory to boot. For small images, size diference might not be huge, but it gets bigger as /usr gets bigger.
```
tarbsd build --quick
```

Raw .img (for bhyve, kvm and real computers) is always generated. If you have qemu-tools installed, it can also be converted to all sorts of random formats.
```
tarbsd build cow qcow qcow2 vdi vmdk vhdx vpc
```

Verbose output doesn't quite show every single little detail yet, but if you like tar -v and pkg install being streamed to your console, you can have them.
```
tarbsd build -v
```

## tarbsd.yml options ##
### root_pwhash ###

### root_sshkey ###

### backup ###
Backup tarbsd.yml as well as the overlay directory inside the image. If you loose the computer, which created the image, you've got backup inside the image itself assuming it runs on another computer and you haven't lost that too.

### busybox ###
Replaces many applications with [busybox](https://en.wikipedia.org/wiki/BusyBox).

### ssh (dropbear|openssh|null) ###
Dropbear is slightly smaller. tarBSD does some tricks here to share the host keys between the two, so you can switch easily without re-keying clients.

### features ###
Things such as ZFS, bhyve and wireguard etc that are only needed by some and thus, are opt-in. Depending on feature, it will include relevant kernel modules, userland tools and sometimes packages. Please, suggest new ones (or send pr) if you think something is missing.

### modules ###
Two lists (early and late) of kernel modules to be included in the image. Early modules are loaded right at the boot, while the late ones will be available later.

### packages ###
List of packages to be installed.

## Updating tarBSD builder to a new version ##
```
tarbsd self-update
```
## Other miscellaneous things ##
* tarBSD lives in memory. If you need non-volatile storage, you need to have it in another storage medium. If you mount something in /usr (which is read-only), make a corressponding empty directory to tarbsd/usr, so it can be mounted.
* Many executables might be missing, but libraries are mostly there. Vast majority of packages should just work.
* tarBSD requires [tarfs](https://man.freebsd.org/cgi/man.cgi?tarfs(5)), which was introuduced in 14.2. Older releases are not supported.
* Builder will automatically add fstab line for following pseudo filesystems if the kernel module is present either through a feature or manual include:
  * procfs
  * fdescfs
  * linprocfs (automatically included in busybox builds)
  * linsysfs
* SSH is on by default unless there's no SSH program. You can disable it by setting sshd_enabled="NO" or dropbear_enable="NO" in etc/rc.conf.
* Compressed kernels and modules are cached at /var/cache/tarbsd and this cache is shared across all tarbsd projects you might have. At the moment, other things such as packages and extracted freebsd distributions are cached locally at the project up until next boot.
* Random reads across various places in /usr might be slightly slow due to obvious reason. Depending on applications, this might or might not be noticeable. Usually however, services are started at boot and that's it, so I guess this doesn't matter much for most. There are some tunables in tar, which might help, but I haven't researched them extremely closely yet.
* Known bug: pkg coredumps aren't detected. I've encountered 260m coredump inside an image, which was supposed to be small. This has however, only happened once.

## Contributing ##
There are some questions in the source code. One way to contribute is by giving input on them.

For development, you'll need [Composer](https://www.freshports.org/devel/php-composer/) to install PHP dependencies. There's a compiler in the stubs directory. It spits out the executable, which is a [phar archive](https://www.php.net/manual/en/intro.phar.php). During development, you can just require vendor/autoload.php, create TarBSD\App and run that, but do at least occasional testing with a phar app too.

If you're not familiar with Symfony components, [here's the docs](https://symfony.com/doc/current/index.html). Relevant parts here are console, process, filesystem and finder.

Builder's predecessor was a shell script and there might be some random leftovers of it in the code. Going forward, file access happens in PHP and not PHP invoking /bin/cp, /bin/rm and /bin/ln. Obvious exceptions to this are cases where tar, makefs or something of that sort is needed.
